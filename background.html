<script type="text/javascript" src="javascripts/jquery.js"></script>
<script type="text/javascript" src="javascripts/json2.js"></script>
<script type="text/javascript" src="javascripts/underscore.js"></script>
<script type="text/javascript" src="javascripts/backbone.js"></script>
<script type="text/javascript" src="javascripts/backbrace.js"></script>
<script type="text/javascript" src="javascripts/humane.js"></script>
<script type="text/javascript" src="javascripts/jquery-ui-1.8.20.custom.min.js"></script>
<script type="text/javascript" src="javascripts/floataway.jquery.js"></script>

<script type="text/javascript" src="javascripts/btapp.js"></script>
<script type="text/javascript" src="javascripts/client.btapp.js"></script>
<script type="text/javascript" src="javascripts/plugin.btapp.js"></script>
<script type="text/javascript" src="javascripts/pairing.btapp.js"></script>
<script type="text/javascript" src="javascripts/jstorage.min.js"></script>
<script>
var btapp = new Btapp;
btapp.connect({
    queries: [
        'btapp/torrent/all/*/properties/all/download_url/',
        'btapp/torrent/all/*/properties/all/hash/',
        'btapp/torrent/all/*/file/all/*/properties/all/streaming_url/',
        'btapp/add/'
    ]
});

var torrents = {};

btapp.live('torrent * properties', function(properties) {
    var url = properties.get('download_url');
    if(torrents[url]) {
        delete torrents[url];
        btapp.get('torrent').get(properties.get('hash')).get('file').each(function(file) {
            var streaming_url = file.get('properties').get('streaming_url');
            chrome.tabs.create({
                url: streaming_url,
                selected: true
            });
        });
    }
});

chrome.webRequest.onBeforeRequest.addListener(
    function(details) {
        console.log('onBeforeRequest');
        console.log(details.url);
        if(btapp.has('add')) {
            btapp.get('add').torrent(details.url);
            torrents[details.url] = true;
        }
        return {
            redirectUrl: details.url
        }; 
    },
    {
        urls: ["*://*/*.torrent"]
    },  
    ["blocking"]
);

</script>
