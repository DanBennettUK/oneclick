<script type="text/javascript" src="javascripts/lib/jquery.js"></script>
<script type="text/javascript" src="javascripts/lib/json2.js"></script>
<script type="text/javascript" src="javascripts/lib/underscore.js"></script>
<script type="text/javascript" src="javascripts/lib/backbone.js"></script>
<script type="text/javascript" src="javascripts/backbrace/backbrace.js"></script>

<script type="text/javascript" src="javascripts/btapp/btapp.js"></script>
<script type="text/javascript" src="javascripts/btapp/client.btapp.js"></script>
<script type="text/javascript" src="javascripts/btapp/plugin.btapp.js"></script>
<script type="text/javascript" src="javascripts/btapp/pairing.btapp.js"></script>
<script type="text/javascript" src="javascripts/jStorage/jstorage.js"></script>


<script>
var btapp = new Btapp;
btapp.connect({
    queries: [
        'btapp/torrent/all/*/properties/all/download_url/',
        'btapp/torrent/all/*/properties/all/hash/',
        'btapp/torrent/all/*/file/all/*/properties/all/streaming_url/',
        'btapp/torrent/all/*/file/all/*/properties/all/name/',
        'btapp/add/'
    ]
});

var torrents = {};
var streaming_urls = {};

btapp.live('torrent * properties', function(properties) {
    var url = properties.get('download_url');
    if(torrents[url]) {
        delete torrents[url];
        var files = btapp.get('torrent').get(properties.get('hash')).get('file');
        if(files.length > 3) {
            alert('Your tab situation is about to get super fucked up by all the files in this big ass torrent. Continue? .... jk. Its too late. That shit got locked down. Figure out what to do with the torrent yourself.');
            return;
        }
        files.each(function(file) {
            var streaming_url = file.get('properties').get('streaming_url');
            var name = file.get('properties').get('name');
            streaming_urls[streaming_url] = name;
            chrome.tabs.create({
                url: streaming_url,
                selected: true
            });
        });
    }
});

chrome.webRequest.onHeadersReceived.addListener(
    function(details) {
        if(details.url in streaming_urls) {
            console.log(details.url);
            var disposition = false;
            for(var i = 0; i < details.responseHeaders.length; i++) {
                if(details.responseHeaders[i].name === 'Content-Disposition') {
                    disposition = true;
                    break;
                }
            }
            if(!disposition) {
                details.responseHeaders.push({
                    name: 'Content-Disposition',
                    value: 'attachment; filename="' + streaming_urls[details.url] + '"'
                });
            }
            for(var i = 0; i < details.responseHeaders.length; i++) {
                console.log(details.responseHeaders[i].name + ': ' + details.responseHeaders[i].value);
            }
            return {responseHeaders: details.responseHeaders};
        }
    },
    {urls: ["http://127.0.0.1:*/proxy*"]},
    ["blocking", "responseHeaders"]
);

chrome.webRequest.onBeforeRequest.addListener(
    function(details) {
        console.log('onBeforeRequest');
        console.log(details.url);
        debugger;
        if(btapp.has('add')) {
            btapp.get('add').torrent(details.url);
            torrents[details.url] = true;
        }
        return {
            redirectUrl: details.url
        }; 
    },
    {
        urls: ["*://*/*.torrent"]
    },  
    ["blocking","requestHeaders"]
);

</script>
